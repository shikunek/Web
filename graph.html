<html>
<head>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>


	<h1 id="B"></h1>

<!-- <header id="header">
  <div class="inner">
    <nav id="menubar">
    <ul id="menu">
        <li class="dropdown"><a href="#">Company</a></li>
        <li class="selected dropdown"><a href="#">Products</a></li>
        <li class="dropdown"><a href="#">News</a></li>
        <li class="dropdown"><a href="#">Downloads</a></li>
        <li><a href="#">Contact</a></li>
    </ul>
    </nav>
  </div>
</header> -->


<!-- <section id="graph">
  <img src="graph.png" alt="Browser GUI" width="600">

</section> -->

<button id="addData" onclick="tryToDisplayTimeline()">Add Data</button>
<canvas id="myChart" width="400" height="400"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.12.1/firebase-database.js"></script>

<script type="text/javascript">

    var actualUser = null;
    var numDays = 0;
    var leftDay = 0;
    var numShownDays = 10;
    var firstDayOfWeek = 0;
    var firstDayShown = null; // Date

  var config = {
    apiKey: "AIzaSyAR7L3KrsOWXYqu0HMcM85EOBPKWSOF9t0",
    authDomain: "testapp-5cce5.firebaseapp.com",
    databaseURL: "https://testapp-5cce5.firebaseio.com",
    projectId: "testapp-5cce5",
    storageBucket: "",
    messagingSenderId: "984038814608"
  };
  firebase.initializeApp(config);

  // window.onload = init();

  // function init()
  // {
     
  //     // window.myLine = new Chart(ctx, myGraph);
  // }
 // var ctx = document.getElementById("myChart").getContext('2d');
 //  window.myLine = new Chart(ctx, myGraph);  
          var myGraph = {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                ]
            },
            options: {
                responsive: true,
                title:{
                    display:true,
                    text:'Chart.js Line Chart'
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Month'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Value'
                        }
                    }]
                }
            }
        };


    window.onload = function() {
      var ctx = document.getElementById('myChart').getContext('2d');
      window.myLine = new Chart(ctx, myGraph);
      window.myLine.update();
    };



  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      // User is signed in.
      console.log(user.email);
      actualUser = user;
      showGraph(user);
    } else {
      // No user is signed in.
      console.log("Nikdo");
    }
  });



  function tryToDisplayTimeline(){
    // add date and value
    // console.log(myGraph.data.datasets[0].label);
    // if (myGraph.data.labels.length == 0) {
        n =  new Date();
            y = n.getFullYear();
            m = n.getMonth() + 1;
            d = n.getDate();
            var now = d + "." + m + "." + y;
            myGraph.data.labels.push(now);
            myGraph.data.datasets.forEach((dataset) => {
                dataset.data.push(2);

          });
            window.myLine.update(); 
    // }
    // else
    // {
    //   var lastDate = myGraph.data.labels[myGraph.data.labels.length - 1];   
    //       var res = lastDate.split(".");
    //       var newDay = parseInt(res[0]) + 1;
    //       var newDate = newDay + "." + res[1] + "." + res[2];
    //       console.log(myGraph.data.datasets[1].label);
    //       var petersLine = myGraph.data.datasets[0];
    //       var jirkasLine = myGraph.data.datasets[1];
    //       myGraph.data.labels.push(newDate);

    //           // var new_X = parseInt($('input[name="gender"]:checked').val()) + 
    //           // parseInt(petersLine.data[petersLine.data.length - 1]);
    //           if (myGraph.data.labels.length > 5) {
    //           myGraph.data.labels.shift();
    //           petersLine.data.shift();
    //           // jirkasLine.data.shift();
    //           };
    //           petersLine.data.push(5);
    //           // jirkasLine.data.push(0);         
    //           window.myLine.update(); 
                  
    // }
  }

  function setDatasetColor(dataset, usersNumber)
  {
      switch (usersNumber)
        {
            case 0: // Base_Red: #e57373, Miss_Red: #ffcdd2
                    dataset.backgroundColor = "rgb(229, 115, 115)"; 
                    // lineDataSet.setColor(Color.argb(255, 229, 115, 115));
                    // lineDataSet.setCircleColor(Color.argb(255, 229, 115, 115));
                break;
            case 1: // Base_Light-Blue: #4fc3f7, Miss_Light-Blue: #b3e5fc
                    dataset.backgroundColor = "rgb(79, 195, 247)"; 
                    // lineDataSet.setColor(Color.argb(255, 79, 195, 247));
                    // lineDataSet.setCircleColor(Color.argb(255, 79, 195, 247));
                break;
            case 2: // Base_Green: #81c784, Miss_Green: #c8e6c9
                    dataset.backgroundColor = "rgb(129, 199, 1325)"; 
                    // lineDataSet.setColor(Color.argb(255, 129, 199, 132));
                    // lineDataSet.setCircleColor(Color.argb(255, 129, 199, 132));
                break;
            case 3: // Base_Purple: #ba68c8, Miss_Purple: #e1bee7
                    dataset.backgroundColor = "rgb(186, 104, 200)"; 
                    // lineDataSet.setColor(Color.argb(255, 186, 104, 200));
                    // lineDataSet.setCircleColor(Color.argb(255, 186, 104, 200));
                break;
            default:
                    dataset.backgroundColor = "rgb(229, 115, 115)"; 
                    // lineDataSet.setColor(Color.BLUE);
                    // lineDataSet.setCircleColor(Color.BLUE);
                break;
        }
        return dataset.backgroundColor;
  }
  

  function someGraphSetting(usersNumber, usersProjectValues)
  {

    var yValues = [];
    yValues.length = 0;
    console.log("yVal");
          console.log(myGraph.data);
    var yValuesMiss = [];

    var y = parseFloat("0");
    var firstEntry = {x: 0, y: y}; 

    yValues.push(firstEntry); // first entry is 0
        
    var lastEntry = {x: 0, y: y}; 

    var lastMissEntry = null;
        var i = 1;
        var preReport = true; // solution for late addition of user and his missed reports
        var lastMiss = false;
        var thisMiss = false;;
        var date;

        // SimpleDateFormat dateFormatter = new SimpleDateFormat("yyyy-MM-dd", Locale.ENGLISH);
        // Calendar actDate = Calendar.getInstance();
        var dataset = {
                      label: "",
                      backgroundColor: 'red',
                      borderColor: 'red',
                      data: [
                      ],
                      fill: false
              
                    }

          // PRVNI PRVEK JE ZVLAST                    
          dataset.backgroundColor = setDatasetColor(dataset, usersNumber);

          myGraph.data.labels.push("prvni");
          dataset.label = usersNumber;
          dataset.data = [];
          dataset.data = yValues;

          // myGraph.data.datasets.push(dataset);
          // dataset.data = [];
          
          if (usersNumber == 0) 
          {
              return;
                    dataset.backgroundColor = 'blue';
                    dataset.borderColor = 'blue';
          };      

    var previousValue = lastEntry;
    console.log(usersProjectValues.val());
      usersProjectValues.forEach(function(usersValue)
      {
          dataset.data = [];
              dataset = {
                        label: usersNumber,
                        backgroundColor: 'red',
                        borderColor: 'red',
                        data: [
                        ],
                        fill: false
                
                      };

              if (usersValue == null) {
                  // return datasets;
              };

              console.log(usersValue.key);
              var smile = usersValue.val().sendValue;

              var key = usersValue.key;
              
              date = new Date(key);
              
              
              if (usersNumber == 0) 
              {
                  myGraph.data.labels.push(usersValue.key);
              };
                  

              thisMiss = smile < -1;

              if (i == 1 && (firstDayShown == null || date < firstDayShown))
              {
                  firstDayShown = date;
                  // DAY_OF_WEEK start 1 = Su
                  // console.log(date.getDay());
                  firstDayOfWeek = (date.getDay()+ 5) % 7;
              };

              if (thisMiss) 
              { // just add new value to miss dataset
                  if (!lastMiss)
                  {
                    //TADY ZMENA, PROTOZE SE DAVALA HODNOTA, KTERA JIZ BYLA PRIDANA
                      // yValuesMiss.push(lastEntry);
                      console.log("1");
                      // console.log(yValuesMiss);
                  }
                      
                  y = translateEntry(y, -1);
                  yValuesMiss.push({x: i, y: y});
                  lastMissEntry = {x: i, y: y};
                  previousValue = lastMissEntry;
                  // console.log("2");
                  // console.log(yValuesMiss);              
              }
              else
              { // !thisMiss && !lastMiss => just add new value to dataset
                  if (lastMiss)
                  {
           
                      console.log("3");
                      console.log(yValuesMiss);
                      console.log(yValues);
                      console.log(myGraph.data);
                      // dataset.backgroundColor = setDatasetColor(dataset, usersNumber);
                      if (myGraph.data.datasets != null) {
                          var lastDataset = myGraph.data.datasets[myGraph.data.datasets.length -1];
                          console.log(yValuesMiss);
                          // yValues.unshift(previousValue);
                          // console.log(yValues);
                          if (lastDataset != null) {

                            for (var i = 0; i < lastDataset.data.length - 1; i++) 
                            {
                                yValues.unshift(null);
                            };
                          };

                      };
                      
                      
                      
                      // dataset.data = [];
                      // yValues.push(null);
                      dataset.data = yValues;              
                      // dataset.data = dataset.data.concat(yValues);
                      myGraph.data.datasets.push(dataset);
                      console.log(dataset);

                       // console.log(dataset.data);
                      // dataset.data = [];
                      dataset = {
                        label: usersNumber,
                        backgroundColor: 'blue',
                        borderColor: 'blue',
                        data: [
                        ],
                        fill: false
                
                      }


                      // myGraph.data.datasets.push(dataset);
                      // dataset.backgroundColor = setDatasetColor(dataset, usersNumber);
                      // dataset.data = [];
                      yValuesMiss.unshift(yValues[yValues.length-1]);
                      for (var i = 0; i < (yValues.length - 1); i++) 
                      {
                          yValuesMiss.unshift(null);
                      };
                      

                      // yValuesMiss.push(yValues[yValues.length-1]);
                      dataset.data = yValuesMiss;
                      // dataset.data.push(null);
                      // dataset.data = dataset.data.concat(yValuesMiss); 
                      myGraph.data.datasets.push(dataset);

                      console.log(dataset);
                      dataset = {
                        label: usersNumber,
                        backgroundColor: 'red',
                        borderColor: 'red',
                        data: [
                        ],
                        fill: false
                
                      };
                      // dataset.data = [];
                      


                      // myGraph.data.datasets.push(dataset);
                      // console.log(dataset.data);
                      
                      yValues = [];
                      // entry to connect last miss and first base entry in base color
                      //TADY ZMENA, PROTOZE SE DAVALA HODNOTA, KTERA JIZ BYLA PRIDANA
                      // yValues.push(lastMissEntry);
                      yValuesMiss = [];
                  }

                  y = translateEntry(y, smile);

                  yValues.push({x: i, y: y});
                  previousValue = {x: i, y: y};
                  console.log("4");
                  console.log(myGraph.data);
                  lastEntry = {x: i, y: y};
              }


              // console.log(previousValue);
              lastMiss = thisMiss;
              i++;

      });
              



        if (usersNumber == 0) 
        {
            usersNumber = false;
                          
        };

        if (i-1 > numDays)
        {
            numDays = i-1;
        }

        if (yValues.length > 0)
        { 
            var plusSpace = myGraph.data.datasets[myGraph.data.datasets.length -1].data.length - 1;
                        console.log("5");
            console.log(myGraph.data);
            var lastValueOfLastDataset = myGraph.data.datasets[myGraph.data.datasets.length -1].data[myGraph.data.datasets[myGraph.data.datasets.length -1].data.length -1];
            yValues.unshift(lastValueOfLastDataset);
            for (var i = 0; i < plusSpace; i++) 
            {
                yValues.unshift(null);
            };
            
            
            // dataset.data = dataset.data.concat(yValues); 
            dataset.data = yValues; 
            // dataset.data.push(null);
            myGraph.data.datasets.push(dataset);
            // dataset.data = [];
            

            // console.log(yValues);

        }

        if (yValuesMiss.length > 0)
        {        
            dataset.backgroundColor = setDatasetColor(dataset, usersNumber);
            // yValuesMiss.unshift(previousValue);
            yValuesMiss.push(previousValue);
            // dataset.data = dataset.data.concat(yValuesMiss); 
            dataset.data = yValuesMiss; 
            myGraph.data.datasets.push(dataset);
            // dataset.data = [];
            
            console.log("6");
            // console.log(dataset);
            // console.log(yValuesMiss);

        }
        console.log("Celkove");
        console.log(myGraph.data);
        // myGraph.data.datasets.push(dataset);
                
  }


  function showGraph(user)
  {
     var userGraphRef = firebase.database().ref('Uzivatel/' + user.uid + '/Projects/-LA8343GgPB692j67alV');
      userGraphRef.on('value', function(project) 
      {
          console.log(project.key);
          myGraph.data.datasets.length = 0;

          var projectGraphRef = firebase.database().ref('Projects/' + project.key);
          projectGraphRef.on('value', function(projectUser) 
          {
                var iUser = 0;
                projectUser.forEach(function(childSnapshot) 
                {

                  var childKey = childSnapshot.key;
                  var childData = childSnapshot.val();

                  if (childKey == "projectName") 
                  {

                    return;

                  };

                  // var dataset = {
                  //   label: iUser,
                  //   backgroundColor: 'blue',
                  //   borderColor: 'yellow',
                  //   data: [null,null,{x:2, y:5},{x:3, y:iUser}],
                  //   fill: false
                
                  // }
                  
                  // var dataset1= {
                  //   label: iUser,
                  //   backgroundColor: 'red',
                  //   borderColor: 'black',
                  //   data: [{x:0, y:iUser},{x:1, y:2},{x:2, y:5}],
                  //   fill: false
                
                  // }
                  // if (iUser == 1) 
                  // {
                  //   dataset.backgroundColor = 'blue';
                  //   dataset.borderColor = 'blue';
                  // };


                  myGraph.data.labels = ["dasd","as","","asd","s","1","11","1rre"];

                  // myGraph.data.datasets.push(dataset1);
                  // myGraph.data.datasets.push(dataset);

                  someGraphSetting(iUser, childSnapshot);
                  console.log(myGraph.data);
                  

                  window.myLine.update();

                  iUser++;
                  
                });
                
          });
      });
  }

  function translateEntry(old_y, smile)
  {
      var new_y = 0;
        var x_delta;
        var shiftPar = 0.4; // the smaller the number, the slower the change
        if (old_y >= 1 || old_y <= -1) { // old value is outside of bounds
            throw "Y-value not within bounds (-1,1)";
        }
        else if (old_y > 0) {
            switch(smile) {
                case  1: // function (1)
                    x_delta = Math.tan(old_y * (Math.PI / 2));
                    x_delta = shiftPar + x_delta;
                    new_y = (Math.atan(x_delta)/(Math.PI / 2));
                    //Log.d("F1", "y_old: " + old_y + ", smile: " + smile + ",\nx_d: " + x_delta + ", new_y: " + new_y + "\n");
                    break;
                case  0: // function (4)
                    x_delta = (-1 * (Math.tan(old_y * (Math.PI / 2) - (Math.PI / 2))));
                    x_delta = shiftPar + x_delta;
                    new_y = (Math.atan(-1 * x_delta) / (Math.PI / 2) + 1);
                    //Log.d("F4", "y_old: " + old_y + ", smile: " + smile + ",\nx_d: " + x_delta + ", new_y: " + new_y + "\n");
                    break;
                case -1: // function (6)
                    x_delta = (-1 * (Math.tan(old_y * (Math.PI / 4) - (Math.PI / 4))));
                    x_delta = shiftPar + x_delta;
                    new_y = (2 * (Math.atan(-1 * x_delta) / (Math.PI / 2)) + 1);
                    //Log.d("F6", "y_old: " + old_y + ", smile: " + smile + ",\nx_d: " + x_delta + ", new_y: " + new_y + "\n");
                    break;
                default:
                    throw "Smile not within bounds [-1,0,1]";
            }
        }
        else if (old_y <0) {
            switch(smile) {
                case  1: // function (5)
                    x_delta = Math.tan(old_y * (Math.PI / 4) + (Math.PI / 4));
                    x_delta = shiftPar + x_delta;
                    new_y = (2 * (Math.atan(x_delta)/(Math.PI / 2)) - 1);
                    //Log.d("F5", "y_old: " + old_y + ", smile: " + smile + ",\nx_d: " + x_delta + ", new_y: " + new_y + "\n");
                    break;
                case  0: // function (3)
                    x_delta = Math.tan(old_y * (Math.PI / 2) + (Math.PI / 2));
                    x_delta = shiftPar + x_delta;
                    new_y = (Math.atan(x_delta)/(Math.PI / 2) - 1);
                    //Log.d("F3", "y_old: " + old_y + ", smile: " + smile + ",\nx_d: " + x_delta + ", new_y: " + new_y + "\n");
                    break;
                case -1: // function (2)
                    x_delta = (-1 * (Math.tan(old_y * (Math.PI / 2))));
                    x_delta = shiftPar + x_delta;
                    new_y = (Math.atan(-1 * x_delta) / (Math.PI / 2));
                    //Log.d("F2", "y_old: " + old_y + ", smile: " + smile + ",\nx_d: " + x_delta + ", new_y: " + new_y + "\n");
                    break;
                default:
                    throw "Smile not within bounds [-1,0,1]";
            }
        }
        else { // old_y == 0
            switch(smile) {
                case  1: // function (1)
                    x_delta = Math.tan(old_y * (Math.PI / 2));
                    x_delta = shiftPar + x_delta;
                    new_y = (Math.atan(x_delta) / (Math.PI / 2));
                    //Log.d("F1", "y_old: " + old_y + ", smile: " + smile + ",\nx_d: " + x_delta + ", new_y: " + new_y + "\n");
                    break;
                case  0:
                    break;
                case -1: // function (2)
                    x_delta = (-1 * (Math.tan(old_y * (Math.PI / 2))));
                    x_delta = shiftPar + x_delta;
                    new_y = (Math.atan(-1 * x_delta) / (Math.PI / 2));
                    //Log.d("F2", "y_old: " + old_y + ", smile: " + smile + ",\nx_d: " + x_delta + ", new_y: " + new_y + "\n");
                    break;
                default:
                    throw "Smile not within bounds [-1,0,1]";
            }
        }

        return new_y;
  }

  //   firebase.database().ref('/Progress/Petr').once('value', function(snapshot) {
//   snapshot.forEach(function(childSnapshot) {
//     if (childSnapshot.key != 'LastAdded') {
//           var childData = childSnapshot.val().Y;
//           myGraph.data.labels.push(childSnapshot.key);
//           myGraph.data.datasets.forEach((dataset) => {
//           dataset.data.push(childData);
//           });
          
//     };
//     window.myLine.update();
//     // ...
//   });
  
// });

  // document.getElementById('addData').addEventListener('click', function() {
  //           if (myGraph.data.datasets.length > 0) {
  //               var month = MONTHS[config.data.labels.length % MONTHS.length];
  //               myGraph.data.labels.push(month);

  //               myGraph.data.datasets.forEach(function(dataset) {
  //                   dataset.data.push(5);
  //               });

  //               window.myLine.update();
  //           }
  //       });

  var MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

 


    // var MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    // var config = {
    //   type: 'line',
    //   data: {
    //     labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
    //     datasets: [{
    //       label: 'My First dataset',
    //       backgroundColor: 'red',
    //       borderColor: 'red',
    //       data: [1,2,3,4,5,6,2
    //       ],
    //       fill: false,
    //     }, {
    //       label: 'My Second dataset',
    //       fill: false,
    //       backgroundColor: 'red',
    //       borderColor: 'red',
    //       data: [
    //         2,3,4,5,6,7,8
    //       ],
    //     }]
    //   },
    //   options: {
    //     responsive: true,
    //     title: {
    //       display: true,
    //       text: 'Chart.js Line Chart'
    //     },
    //     tooltips: {
    //       mode: 'index',
    //       intersect: false,
    //     },
    //     hover: {
    //       mode: 'nearest',
    //       intersect: true
    //     },
    //     scales: {
    //       xAxes: [{
    //         display: true,
    //         scaleLabel: {
    //           display: true,
    //           labelString: 'Month'
    //         }
    //       }],
    //       yAxes: [{
    //         display: true,
    //         scaleLabel: {
    //           display: true,
    //           labelString: 'Value'
    //         }
    //       }]
    //     }
    //   }
    // };

    // window.onload = function() {
    //   var ctx = document.getElementById('canvas').getContext('2d');
    //   window.myLine = new Chart(ctx, config);
    // };

    // document.getElementById('randomizeData').addEventListener('click', function() {
    //   config.data.datasets.forEach(function(dataset) {
    //     dataset.data = dataset.data.map(function() {
    //       return randomScalingFactor();
    //     });

    //   });

    //   window.myLine.update();
    // });

    // var colorNames = Object.keys(window.chartColors);
    // document.getElementById('addDataset').addEventListener('click', function() {
    //   var colorName = colorNames[config.data.datasets.length % colorNames.length];
    //   var newColor = window.chartColors[colorName];
    //   var newDataset = {
    //     label: 'Dataset ' + config.data.datasets.length,
    //     backgroundColor: newColor,
    //     borderColor: newColor,
    //     data: [],
    //     fill: false
    //   };

    //   for (var index = 0; index < config.data.labels.length; ++index) {
    //     newDataset.data.push(randomScalingFactor());
    //   }

    //   config.data.datasets.push(newDataset);
    //   window.myLine.update();
    // });

    // document.getElementById('addData').addEventListener('click', function() {
    //   if (config.data.datasets.length > 0) {
    //     var month = MONTHS[config.data.labels.length % MONTHS.length];
    //     config.data.labels.push(month);

    //     config.data.datasets.forEach(function(dataset) {
    //       dataset.data.push(randomScalingFactor());
    //     });

    //     window.myLine.update();
    //   }
    // });


    //   window.myLine.update();
    // });
  


</script>

</body>
</html>

